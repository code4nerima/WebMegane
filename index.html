<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>WebMegane（色覚体験）</title>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
</head>
<style>
body {
	margin: 0;
	background-color: black;
}
#video {
	display: block;
	width: 100%;
	transform: scale(0.01);
}

#caption {
	z-index: 1;
	display: block;
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 20%;
	color: white;
}

#canvas {
	z-index: 3;
	display: block;
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	filter: null;
}
#debug {
	position: absolute;
	top: 0;
	left: 0;
	background-color: rgb(1, 1, 1, 0.5);
	z-index: 2;
	color: white;
}
</style>
<body>
<canvas id="canvas"></canvas>
<video id="video" autoplay playsinline></video>
<div id=debug></div>
<div id="caption">画面をタップしてモード設定後、VRゴーグルに装着してください。</div>
<svg
	xmlns="http://www.w3.org/2000/svg"
	version="1.1">
	<defs>
		<filter id="protanopia">
		<feColorMatrix
			in="SourceGraphic"
			type="matrix"
			values="0.567, 0.433, 0,     0, 0
					0.558, 0.442, 0,     0, 0
					0,     0.242, 0.758, 0, 0
					0,     0,     0,     1, 0"/>
		</filter>
		<filter id="deuteranopia">
		<feColorMatrix
			in="SourceGraphic"
			type="matrix"
			values="0.625, 0.375, 0,   0, 0
					0.7,   0.3,   0,   0, 0
					0,     0.3,   0.7, 0, 0
					0,     0,     0,   1, 0"/>
		</filter>
		<filter id="tritanopia">
		<feColorMatrix
			in="SourceGraphic"
			type="matrix"
			values="0.95, 0.05,  0,     0, 0
					0,    0.433, 0.567, 0, 0
					0,    0.475, 0.525, 0, 0
					0,    0,     0,     1, 0"/>
		</filter>
		<filter id="achromatopsia">
		<feColorMatrix
			in="SourceGraphic"
			type="matrix"
			values="0.299, 0.587, 0.114, 0, 0
					0.299, 0.587, 0.114, 0, 0
					0.299, 0.587, 0.114, 0, 0
					0,     0,     0,     1, 0"/>
		</filter>
	</defs>
</svg>
</body>
<script src="fukuno.js"></script>
<script>"use strict";
window.onload = function() {
	const USE_CAMERA_FRONT = false;
//	var videoop = USE_CAMERA_FRONT ? true : { facingMode : { exact : "environment" } };
//	var videoop = USE_CAMERA_FRONT ? true : { facingMode : { ideal : "environment" } };
	var videoop = USE_CAMERA_FRONT ? true : {
		facingMode : { ideal : "environment" },
		width: { min: 640, ideal: 1920 },
		height: { min: 480, ideal: 1080 }
//		width: { min: 640, ideal: 1280, max: 1920 },
//		height: { min: 480, ideal: 720, max: 1080 }
	};
	const medias = { audio: false, video: videoop };
	
//	dump(navigator.mediaDevices.getSupportedConstraints());
	
	navigator.getUserMedia(medias, function(stream) {
			video.srcObject = stream;
		},
		function(err) {
			alert(err);
		}
	);

	var mode = 0;
	var filters = [ "", "url(#protanopia)", "url(#deuteranopia)", "url(#tritanopia)", "url(#achromatopsia)", "blur(5px)"];
	var names = [ "C型", "P型", "D型", "T型", "A型", "LV（低視力）"];

	var g = canvas.getContext("2d");
	var draw = function() {
		const cw = window.innerWidth;
		const ch = window.innerHeight;
		canvas.width  = cw;
		canvas.height = ch;
		const vw = video.videoWidth;
		const vh = video.videoHeight;
		const cw2 = cw / 2;
		const caspect = ch / cw2;
		const vaspect = vh / vw;
		
/*		const fitwidth = caspect < vaspect; // auto fit screen */
		const fitwidth = true; // force fit width
//		const fitwidth = false; // force fit height

		g.lineWidth = 5;
    	g.fillStyle = "#fff";
		g.font = "40px sans-serif";
		g.strokeStyle = "#000";
		g.lineJoin = "round";

		var name = names[mode];

		var drawText = function(x, y) {
			x += 10 ;
			y += 30 ;
			
			g.strokeText(name, x, y);
			g.globalCompositeOperation = "destination-out";
			g.fillStyle = "#000";
			g.fillText(name, x, y);
			g.globalCompositeOperation = "source-over"; 
			g.fillStyle = "#fff";
			g.fillText(name, x, y);
		} ;

		if (fitwidth) {
			const vh2 = vw * caspect;
			if (vh2 > vh) {
				const cy = (vh2 - vh) / 2 / (vw / cw2);
				const ch2 = cw2 * vaspect;
				g.drawImage(video, 0, 0, vw, vh, 0, cy, cw2, ch2);
				g.drawImage(video, 0, 0, vw, vh, cw2, cy, cw2, ch2);
				drawText(0, cy);
				drawText(cw2, cy);
			} else {
				const vy = (vh - vh2) / 2;
				g.drawImage(video, 0, vy, vw, vh2, 0, 0, cw2, ch);
				g.drawImage(video, 0, vy, vw, vh2, cw2, 0, cw2, ch);
				drawText(vh2, 0);
				drawText(vh2, cw2);
			}
		} else {
			const vw2 = vh / caspect;
			if (vw2 > vw) {
				const cx = (vw2 - vw) / 2 / (vh / ch);
				const cw3 = ch / vaspect;
				console.log(cx);
				g.drawImage(video, 0, 0, vw, vh, cx, 0, cw3, ch);
				g.drawImage(video, 0, 0, vw, vh, cw2 + cx, 0, cw3, ch);
				drawText(cx, 0);
				drawText(cw2 + cx, 0);
			} else {
				const vx = (vw - vw2) / 2;
				g.drawImage(video, vx, 0, vw2, vh, 0, 0, cw2, ch);
				g.drawImage(video, vx, 0, vw2, vh, cw2, 0, cw2, ch);
				drawText(0, 0);
				drawText(cw2, 0);
			}
		}

		requestAnimationFrame(draw);
	};
	draw();
	
	canvas.onmousedown = function() {
		mode = (mode + 1) % filters.length;

		canvas.style.filter = filters[mode] ;
		var can = document.getElementById("canvas");
		document.getElementById("caption").innerText = names[mode] ;
	};
};
</script>
</html>
